name: Update Homebrew Tap

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v0.1.1)"
        required: true
  workflow_call:
    inputs:
      version:
        description: "Release tag (e.g. v0.1.1)"
        type: string
        required: true

permissions:
  contents: read

jobs:
  update-tap:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      - name: Set version variables
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NO_V=$VERSION_NO_V" >> $GITHUB_ENV
          echo "Updating to version: $VERSION ($VERSION_NO_V)"

      - name: Wait for release assets
        run: |
          echo "Waiting 30 seconds for release assets to be fully uploaded..."
          sleep 30

      - name: Download release assets
        run: |
          mkdir -p dist
          cd dist

          # Download the checksums file with retry logic
          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -L -o checksums.txt \
              "https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/checksums.txt"; then
              echo "Successfully downloaded checksums.txt"
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Download failed, retrying in 10 seconds... (Attempt $RETRY_COUNT/$MAX_RETRIES)"
              sleep 10
            else
              echo "Failed to download checksums.txt after $MAX_RETRIES attempts"
              exit 1
            fi
          done

          cat checksums.txt

      - name: Extract checksums
        id: checksums
        run: |
          ARM64_SHA=$(grep -E "^[a-f0-9]+[[:space:]]+haloy-darwin-arm64$" dist/checksums.txt | awk '{print $1}')
          AMD64_SHA=$(grep -E "^[a-f0-9]+[[:space:]]+haloy-darwin-amd64$" dist/checksums.txt | awk '{print $1}')

          if [[ -z "$ARM64_SHA" || -z "$AMD64_SHA" ]]; then
            echo "Error: Could not extract checksums"
            echo "Contents of checksums.txt:"
            cat dist/checksums.txt
            exit 1
          fi

          echo "ARM64_SHA=$ARM64_SHA" >> $GITHUB_ENV
          echo "AMD64_SHA=$AMD64_SHA" >> $GITHUB_ENV
          echo "Found ARM64 SHA: $ARM64_SHA"
          echo "Found AMD64 SHA: $AMD64_SHA"

      - name: Checkout main repo for template
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: haloydev/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula from template
        run: |
          sed -e "s/{{VERSION}}/${{ env.VERSION_NO_V }}/g" \
              -e "s/{{VERSION_TAG}}/${{ env.VERSION }}/g" \
              -e "s/{{ARM64_SHA}}/${{ env.ARM64_SHA }}/g" \
              -e "s/{{AMD64_SHA}}/${{ env.AMD64_SHA }}/g" \
              main-repo/.github/homebrew-formula.rb.template > homebrew-tap/haloy.rb

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add haloy.rb
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update haloy to ${{ env.VERSION }}"
          git push
